<!DOCTYPE html>
<html>
<head>

<!-- START SIGMA IMPORTS -->
<script src = "sigma-min/sigma.min.js"></script>
<script src = "sigma-min/plugins/sigma.plugins.dragNodes.min.js"></script>
<script src = "sigma-min/plugins/sigma.layout.forceAtlas2.min.js"></script>
<script src = "sigma-min/plugins/sigma.plugins.animate.min.js"></script>
<script src = "sigma-min/plugins/sigma.renderers.customEdgeShapes.min.js"></script>
<script src = "sigma-helpers/sigmaDrawer.js"></script>

<!-- END SIGMA IMPORTS -->
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="css/imagenetwork.css" />
<title>Image Network</title>
</head>
<body>
	<!-- Begin NavBar Module -->
	<div id="headerContent"
		style="overflow-y: hidden; padding-left: 2px; text-align: left; vertical-align: middle; animation: fadeInFromTop 0.1s forwards;">
		<img src="images/logotentative.png" height=45px />

		<button class="animatedButton" onclick="toggleNavBar()"
			style="cursor: pointer; float: right; margin-right: 20px; background-color: inherit;"
			height=45px>=</button>
		<img src="images/spider_icon.png" onclick="toggleWolfgang();"
			style="float: right; padding-right: 20px;" height=45px />

	</div>
	<div id="database-adjacent-reverse">

		<h1 class="buttonDivider">Images</h1>
		<div id="database-subfill" style="background-color: #555555;">
			<table	style="text-align: center; background-color: #555555; width: 100%; border-bottom: 1px solid grey;">
				<tr>
					<td><img id="profile_pic" src="images/default_profilepicture.png"
						style="padding: 10px; border-radius: 25px;" width=70 /></td>
					<td>
						<table style="text-align: left">
							<tr>
								<td id="dashboardProfile"></td>
							</tr>
							<tr>
								<td><a href="profiledetails.html">Profile Details</a></td>
							</tr>
							<tr>
								<td><a href="#" id="sign-out">Sign Out</a></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			

			<p class="buttonDivider" style="text-align: left">MY WEB</p>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'dashboard.html'">DASHBOARD</button>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'images.html'">IMAGES</button>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'explore.html'">EXPLORE</button>
			<p class="buttonDivider" style="text-align: left">SOCIAL</p>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'users.html'">USERS</button>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'pokes.html'">POKES</button>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'friendsearch.html'">FRIEND SEARCH</button>
			<p class="buttonDivider" style="text-align: left">SITE</p>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'contact.html'">CONTACT</button>
			<button class="animatedButton" style="width: 100%; text-align: left"
				onclick="location.href = 'contact.html'">SITE POLICY</button>

			<script type="text/javascript">
				sideToggled = true;
				document.getElementById("database-adjacent-reverse").style.animation = "offscreenLeft 0.1s forwards";
				function toggleNavBar() {
					if (!sideToggled)

						document.getElementById("database-adjacent-reverse").style.animation = "offscreenLeft 0.1s forwards";
					else
						document.getElementById("database-adjacent-reverse").style.animation = "backToScreenLeft 0.1s forwards";
					sideToggled = !sideToggled;
				}

				function mouseOverNavBar() {
					if (document.getElementById("database-adjacent-reverse").style.animation === "offscreenLeft 0.1s forwards")
						document.getElementById("database-adjacent-reverse").style.animation = "backToScreenLeft 0.1s forwards";
					sideToggled = false;
				}
			</script>
			<button class="symbolButton" id="sideToggle" onclick="toggleNavBar()"
				onmouseover="mouseOverNavBar()"
				style="position: absolute; left: 100%; bottom: 0; width: 10px; padding: 0; height: 100%;">|||</button>
		</div>
	</div>



	<!--  Wolfgang Module -->
	<script src="js/wolfgang.js"></script>
	<div id="wolfgang"
		style="display: none; position: absolute; top: 500px; left: 500px; z-index: 100">
		<p
			style="position: absolute; left: 100%; bottom: 75%; transform: rotate(45deg); background-color: #ffffff; border-radius: 25px;"
			width=200>|</p>
		<div id="wolfgangSpeechBubble"
			style="position: absolute; left: 100%; bottom: 100%; width: 400px;">
			<p id="wolfgangText"
				style="background-color: #ffffff; color: #000000; text-align: center; padding: 30px; border-radius: 55px;">Howdy!
				I'm Wolfgang! If you can't find your way around, you can find me in
				the upper right corner of the screen!</p>
			<button class="animatedButton" onclick="toggleWolfgang()"
				style="position: absolute; bottom: 75%; left: 95%; border-radius: 40px; padding: 5px; font-size: 10px; background-color: #ff0000">X</button>
		</div>
		<img src="images/spider.png" onclick="generateSpideryWisdom()"
			width=100 />
	</div>
	<!-- END Wolfgang Module -->

	<!-- End NavBar Module -->


	<div id="coverbannerblock"
		style="z-index: -1; left: 0; position: absolute; padding-top: 75px; padding-left: 45px; line-height: 1;">
		<h1>Images</h1>
		<p>Manage your uploaded memories.</p>
		
		<!--
		<div id="uploadWidget" style="padding: 10px; width: 100%; background-color: #222222; border-radius: 6px">
			<h2 class="buttonDivider" style="width: auto">Image Upload</h2>
			<br />
			<form>
				<input type="file" name="pic" accept="image/*" /><input type="submit" />
			</form>
			<br />
			<br />
		</div>
		<br />
		!-->
		<div id="uploadWidget" class="ICWidget" style="width: auto">
			<h2 class="buttonDivider" style="width: auto">Image Upload</h2>
			<br />
			<!-- <form name="uploadForm"> -->
				<progress id="uploader" value="0" max="100" id="uploader">0%</progress>
				<br />
				<input id="fileButton" type="file" name="pic" accept="image/*" />
			<!-- 	<input type="submit" />
			</form> -->
			<br />
			<br />
		</div>
		<br />
		<br />
		
		
	</div>
	<div id="rightblock"
		style="position: absolute; top: 75px; bottom: 45px; right: 45px; left: 400px; text-align: left; line-height: 1">
	
		<div id="photoManagerWidget" class="ICWidget" style="width: 100%; height: 100%">
			<h2 id="myImages" class="buttonDivider" style="width: auto">My Images</h2>
			<!-- APPEND IMAGE DATA HERE FROM THE DATABASE -->
			
			
			
			
			
			
		</div>
	</div>
			<div id='network-graph' 
	style="opacity:0; z-index: -100; animation: fadeIn 1s ease-in 0s forwards;"></div>
	<script>drawGraphStill('network-graph', 50, ((25*24) / 2), '#2fa87e', '#2fa87e', 1, 3)</script>
	
	<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
		<script>
			//initialize firebase
			 var config = {
			    apiKey: "AIzaSyBXwd0A6u5uWUHX9GxiT-TcwkAac_X-Wx4",
			    authDomain: "image-network.firebaseapp.com",
			    databaseURL: "https://image-network.firebaseio.com",
			    storageBucket: "image-network.appspot.com",
			    messagingSenderId: "268082674497"
			  };
	
			 firebase.initializeApp(config);
		
			  
			  var uploader = document.getElementById('uploader');
			  var fileButton = document.getElementById('fileButton');
			
			  var img = document.getElementById("profile_pic");
			  
			  var currentUser;
			  var userid;
			  var imageDiv = document.getElementById("myImages");
			  
			  firebase.auth().onAuthStateChanged(function(user) {
				  if (user) {
					  currentUser = user;
					  console.log(user);
					  console.log(currentUser);
					  userid = user.uid;
					  
				/* 	  
					  firebase.database().ref('/users/'+ userid + '/images/image0').once('value').then(function(snapshot){
							var profilePic = snapshot.val();
							
							var storageRef = firebase.storage().ref(profilePic);
							console.log(profilePic);
					  
							storageRef.getDownloadURL().then(function(url){
						
							  var xhr = new XMLHttpRequest();
							  xhr.responseType = 'blob';
							  xhr.onload = function(event) {
							    var blob = xhr.response;
							  };
							  xhr.open('GET', url);
							  xhr.send();
								
							  img.src = url;
								
							}).catch(function(error){
								console.log(error);
							});
							
					  }); */ 
					  var num;
					  firebase.database().ref('/users/'+ userid + '/images').once("value").then(function(snapshot){
						  
							console.log(snapshot.val());
							num = snapshot.numChildren();
							console.log(num);
							console.log(snapshot.numChildren());
							
							
							for (i = 0; i < num; i++) { 
								firebase.database().ref('/users/'+ userid + '/images/image' + i).once('value').then(function(snapshot){

									
									var profilePic = snapshot.val();
									
									var storageRef = firebase.storage().ref(profilePic);
									console.log(profilePic);
							  
									storageRef.getDownloadURL().then(function(url){
								
									/*   var xhr = new XMLHttpRequest();
									  xhr.responseType = 'blob';
									  xhr.onload = function(event) {
									    var blob = xhr.response;
									  };
									  xhr.open('GET', url, false);
									  xhr.send();
									   */
									// if(i == 1){
										
									 		img.src = url;
									 //}
						
	 
									  var newImage = document.createElement("image");
										
										newImage.setAttribute('src', url);
										
										imageDiv.appendChild(newImage)
									  
								      
										
									}).catch(function(error){
										console.log(error);
									});

									
							  });
							}
						
							
						});
						
					
				  } else {
				   
				  }
				});
			  

				fileButton.addEventListener('change', upload);
				
				function upload(e){
					//get file
					var file = e.target.files[0];
					//create a storage ref
					var storageRef = firebase.storage().ref('user_uploads/' + file.name);
					
					
					
					console.log(file.name);
					
					//Upload file
					var task = storageRef.put(file);
					//update progress bar
					
					task.on('state_changed',
						function progress(snapshot){
							var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
							uploader.value = percentage;
						
						},
						
						function error(err){
							console.log(err);
						},
						
						function complete(){
							var user = firebase.auth().currentUser;
							var userid = user.uid;
							var num = 0;
							
							
							firebase.database().ref('/users/'+ userid + '/images').once("value").then(function(snapshot){
								num = snapshot.numChildren();
								
								var updates = {};
								var path = '/users/' + userid + '/images/image' + num;
								
								updates['/users/' + userid + '/images/image' + num] = storageRef.fullPath;
								firebase.database().ref().update(updates)
								

							});
							
							 storageRef.getDownloadURL().then(function(url){
									
								 	var xhttp = new XMLHttpRequest();
									//gets the path
									var path = "/"+window.location.pathname.split("/")[1];
									//create url
								
									
									
									
									var url2 = path + "/ImageServlet?userID=" + userid + "&imageID=image"+num +"&imageUrl=" + url;						
									xhttp.open("GET", url2, false);
									xhttp.send();
			
							
							}).catch(function(error){
								console.log(error);
							});
							
							
							
						}
					)			
				}
			  
			  
			
			
			</script>
		
</body>
</html>